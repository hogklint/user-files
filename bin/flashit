#!/bin/bash

function error()
{
  echo "Error: $@" >&2
  exit -1
}

[ -z ${AOSP_HOME+x} ] && error "AOSP_HOME not set"
[ -z ${PROJ_DEVICE+x} ] && error "PROJ_DEVICE not set"
[ -z ${PROJ_PRODUCT+x} ] && error "PROJ_PRODUCT not set"
[ -z ${IMAGE_DIR+x} ] && error "IMAGE_DIR not set"

CONSOLE_LOG=0
PERMISSIVE=0

while getopts acdp option
do
    case "$option"
        in
        a)
            ABL="--abl"
            ;;
        d)
            DISABLE="--disable-verity --disable-verification"
            ;;
        p)
            PERMISSIVE=1
            CMDLINE="--cmdline"
            ;;
        c)
            CONSOLE_LOG=1
            CMDLINE="--cmdline"
            ;;
        ?)
            error "Unknown option"
            ;;
    esac
done

shift $((OPTIND-1))

if [ 1 -eq $# ]
then
    FLASH_THIS="$1"
else
    # fast_flashfiles directory missing
    #FLASH_THIS="$AOSP_HOME/out/target/product/$PROJ_DEVICE/fast_flashfiles"
    FLASH_THIS="$AOSP_HOME/out/target/product/$PROJ_DEVICE/$PROJ_PRODUCT-flashfiles-eng.aosp_builder.zip"
    if [ "$PROJ_PRODUCT" = mermaid ]
    then
        FLASH_THIS=$REPO_HOME/../docker_tmp
    fi
fi

function create_cmdline()
{
    if [ -n "$CMDLINE" ] && [ ! -f cmdline.img ]
    then
        echo "Creating permissive cmdline.img"
        CMD=""
        if [ "$PERMISSIVE" -eq 1 ]
        then
            CMD="enforcing=0\nandroidboot.selinux=permissive\n"
        fi
        if [ "$CONSOLE_LOG" -eq 1 ]
        then
            CMD="${CMD}loglevel=7\n"
        fi

        dd if=/dev/zero of="cmdline.img" bs=1M count=1 iflag=fullblock
        echo -en "$CMD" | dd of=cmdline.img conv=nocreat,notrunc
    fi
}

function wait_for_fastboot()
{
    echo -n "Waiting for fastboot device..."
    while [ $(fastboot devices | wc -l) -eq 0 ]
    do
        echo -n .
        sleep 1
    done
    echo "Found"
}

function intel_fastboot()
{
    chmod 750 fastboot.sh
    unset ANDROID_SERIAL
    set -x
    ./fastboot.sh $ABL $DISABLE $CMDLINE || error "fastboot.sh failed"
    set +x
}

function qcom_fastboot_push()
{
    pushd fastboot_Snapdragon* > /dev/null
    qcom_fastboot
    popd > /dev/null
}

function qcom_fastboot()
{
    unset ANDROID_SERIAL
    set -x
    bash fastboot_cmds || error "fastboot_cmds failed"
    fastboot reboot
    set +x
}

# Expand snapdragon glob
function exists()
{
    [ "$#" -eq 1 ] && [ -f "$1" ]
}

function run_fastboot()
{
    echo "Flashing from: $FLASH_THIS"
    if [ -f "fastboot.sh" ]
    then
        intel_fastboot
    elif [ -f "fastboot_cmds" ]
    then
        qcom_fastboot
    elif exists fastboot_Snapdragon*/fastboot_cmds
    then
        qcom_fastboot_push
    else
        error "No fastboot script found"
    fi
}

function is_url()
{
    url_regex='(https?|ftp|file)://[-A-Za-z0-9\+&@#/%?=~_|!:,.;]*[-A-Za-z0-9\+&@#/%=~_|]'
    [[ $1 =~ $url_regex ]]
}

function dl_file
{
    IMAGE_NAME=$(basename "$1")
    FLASH_THIS="$IMAGE_DIR/$IMAGE_NAME"
    if [ -f "$FLASH_THIS" ]
    then
        echo "Image already downloaded: $FLASH_THIS"
        return
    fi

    echo "Downloading to $FLASH_THIS"
    curl -o "$FLASH_THIS" "$1" || error "Could not download "$1" to $IMAGE_DIR"
}

function unpack_tar
{
    TMP_DIR="$(mktemp -d)" || error "Could not create temp directory"
    trap "rm -r $TMP_DIR $TMP_FILE" EXIT
    tar xvf "$FLASH_THIS" -C "$TMP_DIR" || error "Could not extract $FLASH_THIS to $TMP_DIR"
    FLASH_THIS="$TMP_DIR"
}

function unpack_zip
{
    TMP_DIR="$(mktemp -d)" || error "Could not create temp directory"
    trap "rm -r $TMP_DIR $TMP_FILE" EXIT
    unzip -d "$TMP_DIR" "$FLASH_THIS" || error "Could not unzip $FLASH_THIS to $TMP_DIR"
    FLASH_THIS="$TMP_DIR"
}

is_url $FLASH_THIS && dl_file $FLASH_THIS

[ -f "$FLASH_THIS" ] && [ "zip" = ${FLASH_THIS##*.} ] && unpack_zip
[ -f "$FLASH_THIS" ] && [ "gz" = ${FLASH_THIS##*.} ] && unpack_tar

[ -d "$FLASH_THIS" ] || error "Flashfiles directory missing: $FLASH_THIS"

pushd $FLASH_THIS > /dev/null

create_cmdline

if [ $PROJ_PRODUCT = asdf4_kraken ]
then
    [ $(fastboot devices | wc -l) -ne 1 ] && vip pwr bm 2
elif [ "$PROJ_PRODUCT" = hydra ] || [ "$PROJ_PRODUCT" = mermaid ]
then
    [ $(fastboot devices | wc -l) -ne 1 ] && adb reboot bootloader
fi

wait_for_fastboot

run_fastboot

if [ $PROJ_PRODUCT = kraken ]
then
    vip pwr bm 1
fi

popd > /dev/null

